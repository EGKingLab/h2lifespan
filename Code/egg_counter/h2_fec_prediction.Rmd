---
title: "h2 fecundity analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = FALSE)

library(tidyverse)
library(cowplot)
library(readxl)
library(cvTools)
library(rethinking)
```

## Regression on handcounted images

```{r}
linear_threshold <- 46

# Load data for handcounts
HC <- suppressWarnings(
  read_excel("../../Data/Processed/hd_hand_counted.xlsx") %>% 
  dplyr::select(camera_id, handcount)
)

# Load list of bad images that were handcounted
bad_images <- read_excel("../../Data/Processed/bad_images.xlsx") %>% 
  filter(status == "bad") %>% 
  rename(camera_id = cameraid)

# Drop bad images
HC <- HC %>%
  filter(!(camera_id %in% bad_images$camera_id))

linear_area <- read_csv("../../Data/Processed/area_summation_HC.csv",
                       col_types = "cii") %>% 
  filter(lower_thresh == linear_threshold) %>% 
  dplyr::select(-lower_thresh) %>% 
  rename(area_linear = area)

# Join handcounts with areas
HC <- inner_join(HC, linear_area) %>% 
  as.data.frame()

# Load image dimensions and merge
img_size <- read_csv("../../Data/Processed/image_dimensions_hd_hand_counted_masked.csv")
HC <- left_join(HC, img_size)
```

Training image size

```{r}
img_size %>% 
  arrange(desc(img_size))

img_size %>% 
  ggplot(aes(img_size)) +
  geom_histogram()
```

Check these areas: should be in the test_case batch but aren't.

```{r}
HC %>% 
  filter(is.na(area_linear))
```

## Examine possibly bad images

```{r check_bad_images}
plot_jpeg = function(path, add=FALSE) {
  # https://stackoverflow.com/a/28729601/168137
  require('jpeg')
  jpg = readJPEG(path, native = TRUE) # read the file
  res = dim(jpg)[2:1] # get the resolution, [x, y]
  if (!add) # initialize an empty plot area if add==FALSE
    plot(1, 1,
         xlim = c(1, res[1]), ylim = c(1, res[2]),
         asp = 1, type = 'n', xaxs = 'i',
         yaxs = 'i', xaxt = 'n', yaxt = 'n',
         xlab = '', ylab = '', bty = 'n', main = path)
  rasterImage(jpg, 1, 1, res[1], res[2])
}

flagged_images <- HC %>% 
  filter(area_linear > 2.5e05)

basedir <- "../../../h2_fec_images/h2_thresh_images/"

if (nrow(flagged_images) >= 1) {
  for (ii in 1:nrow(flagged_images)) {
    print(plot_jpeg(paste0(basedir, flagged_images$camera_id[ii])))
  }
}
```

## Prediction for all images

Linear model predicting egg count from area:

```{r fm_linear, results="hide", warning=FALSE}
fm_lm1 <- lm(handcount ~ I(area_linear^0.5) - 1, data = HC)
fm_lm2 <- lm(handcount ~ I(area_linear^0.5) + img_size - 1, data = HC)
fm_lm3 <- lm(handcount ~ I(area_linear^0.5) * img_size - 1, data = HC)
```

Cross validation

```{r}
set.seed(4357896)

cv_fm1 <- cvFit(fm_lm1, K = 10, R = 1000, data = HC, y = HC$handcount)
cv_fm2 <- cvFit(fm_lm2, K = 10, R = 1000, data = HC, y = HC$handcount)
cv_fm3 <- cvFit(fm_lm3, K = 10, R = 1000, data = HC, y = HC$handcount)
```

```{r}
cvSelect(cv_fm1, cv_fm2, cv_fm3)
anova(fm_lm1, fm_lm2, fm_lm3, test = "Chisq")
```

```{r}
area_linear <- seq(0, 1.25 * max(HC$area_linear),
                   length.out = 200)
img_size <- min(HC$img_size):max(HC$img_size)
new_data <- crossing(area_linear, img_size) %>% 
  filter(img_size %% 250 == 0)

new_data$lm_pred <- predict(fm_lm3, newdata = new_data)

ggplot() +
  geom_line(data = new_data, aes(x = area_linear, y = lm_pred, color = factor(img_size))) +
  geom_point(data = HC, aes(x = area_linear, y = handcount))
```

## Bayesian model

```{r eval=FALSE}
HC_stan <- HC %>%
  mutate(area_linear = sqrt(area_linear)) %>% 
  drop_na() %>% 
  as.data.frame()

fm_stan <- map2stan(
  alist(
    handcount ~ dnorm(mu, sigma),
    mu <- barea * area_linear + bimg_size * img_size,
    barea ~ dnorm(0, 5),
    bimg_size ~ dnorm(0, 1),
    sigma ~ dcauchy(0, 5)
  ),
  data = HC_stan,
  chains = 4,
  cores = 4,
  control = list(max_treedepth = 15,
                 adapt_delta = 0.95),
  constraints = list(bimg_size = "lower=0",
                     barea = "lower=0")
)
```

```{r eval=FALSE}
plot(fm_stan)
precis(fm_stan)
```

```{r eval=FALSE}
area_linear <- sqrt(seq(0, 1.25 * max(HC$area_linear),
                   length.out = 200))
img_size <- mean(HC$img_size)
new_data <- crossing(area_linear, img_size)

sims <- link(fm_stan, data = new_data)
new_data$lm_pred <- colMeans(sims)

ggplot() +
  geom_line(data = new_data, aes(x = area_linear^2, y = lm_pred)) +
  geom_point(data = HC, aes(x = area_linear, y = handcount))
```

## Evaluation of linear model

```{r}
HC$lm_pred <- predict(fm_lm3)

cor(HC$handcount, HC$lm_pred)
```

## Predict for new data

```{r}
suppressWarnings(
  M <- read_excel("../../Data/Processed/feclife_with-image-ids.xlsx")
)

# Load areas
h2_fec_areas <- read_csv("../../Data/Processed/area_summation_linear_h2_fecimages.csv",
                         col_types = "cii")

M <- left_join(M, h2_fec_areas) %>% 
  rename(area_linear = area) %>% 
    drop_na(area_linear)

# Load image dimensions and merge
img_size <- read_csv("../../Data/Processed/image_dimensions_h2_fec_images.csv")
M <- left_join(M, img_size)

M$predicted_count_linear <- predict(fm_lm1, newdata = M)
```

Prediction image size

```{r}
img_size %>% 
  arrange(desc(img_size))

img_size %>% 
  ggplot(aes(img_size)) +
  geom_histogram()
```

## Checks

Check these. They are handcounted but in the set of analyzed images.

```{r}
M %>% 
  filter(is.na(test_case)) %>% 
  filter(!is.na(handcount)) %>% 
  filter(handcount != "unassessable") %>% 
  filter(handcount != "unassigned") %>% 
  mutate(handcount = as.numeric(handcount)) %>% 
  select(camera_id, handcount, predicted_count_linear) %>% 
  filter(!is.na(predicted_count_linear)) %>% 
  as.data.frame()
```

## Some exploration

```{r}
ggplot(M, aes(predicted_count_linear)) +
  geom_histogram(bins = 30)
```

Check high and low predicted eggs

```{r}
M %>% 
  select(camera_id, predicted_count_linear) %>% 
  arrange(desc(predicted_count_linear))
```

```{r}
M %>% 
  select(camera_id, predicted_count_linear) %>% 
  arrange(predicted_count_linear)
```


```{r eval=FALSE}
M.low <- M %>% 
 select(camera_id, predicted_count_linear) %>% 
 arrange(predicted_count_linear)

M.low <- M.low[1:300,]

ee <- read_excel("../../Data/Processed/egg_notes_EGK.xlsx")
ee$Image <- paste("IMG_", ee$Image, ".JPG", sep = "")
ww <- which(M.low$camera_id %in% ee$Image)

M.low <- M.low[-ww,]

set.seed <- 8462
set.zeros <- M.low[sample(seq(1, nrow(M.low)), 10) , ]
```

## Examine possibly bad images

```{r check_bad_images_2, eval = TRUE}
plot_jpeg = function(path, add=FALSE) {
  # https://stackoverflow.com/a/28729601/168137
  require('jpeg')
  jpg = readJPEG(path, native = TRUE) # read the file
  res = dim(jpg)[2:1] # get the resolution, [x, y]
  if (!add) # initialize an empty plot area if add==FALSE
    plot(1, 1,
         xlim = c(1, res[1]), ylim = c(1, res[2]),
         asp = 1, type = 'n', xaxs = 'i',
         yaxs = 'i', xaxt = 'n', yaxt = 'n',
         xlab = '', ylab = '', bty = 'n', main = path)
  rasterImage(jpg, 1, 1, res[1], res[2])
}

flagged_images <- M %>% 
  filter(predicted_count_linear > 2000)

basedir <- "../../../h2_fec_images/h2_thresh_fecimages/"

if (nrow(flagged_images) >= 1) {
  for (ii in 1:nrow(flagged_images)) {
    print(plot_jpeg(paste0(basedir, flagged_images$camera_id[ii])))
  }
}
```

# Save output for further filtering & analysis

```{r}
save(M, file= "../../Data/Processed/predicted_egg_counts.rda")
```
