---
title: "h2 fecundity analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(cowplot)
library(readxl)
library(ggrepel)
library(rethinking)
```

## Regression on handcounted images

```{r}
asymp_threshold <- 74
linear_threshold <- 46

HC <- suppressWarnings(
  read_excel("../../Data/Processed/hd_hand_counted.xlsx") %>% 
  dplyr::select(camera_id, handcount)
)

bad_images <- read_excel("../../Data/Processed/bad_images.xlsx") %>% 
  filter(status == "bad") %>% 
  rename(camera_id = cameraid)

# Drop bad images
HC <- HC %>%
  filter(!(camera_id %in% bad_images$camera_id))

asymp_area <- read_csv("../../Data/Processed/area_summation_asymp_fine.csv") %>% 
  filter(lower_thresh == asymp_threshold) %>% 
  dplyr::select(-lower_thresh) %>% 
  rename(area_asymp = area)

HC <- full_join(HC, asymp_area) %>% 
  as.data.frame()
```

Check these areas: should be in the test_case batch but aren't.

```{r}
actual %>% 
  filter(is.na(area))
```

## Examine possibly bad images

```{r check_bad_images}
plot_jpeg = function(path, add=FALSE) {
  # https://stackoverflow.com/a/28729601/168137
  require('jpeg')
  jpg = readJPEG(path, native=T) # read the file
  res = dim(jpg)[2:1] # get the resolution, [x, y]
  if (!add) # initialize an empty plot area if add==FALSE
    plot(1, 1,
         xlim=c(1,res[1]),ylim=c(1,res[2]),
         asp=1, type = 'n', xaxs = 'i', yaxs = 'i', xaxt = 'n', yaxt = 'n',
         xlab = '', ylab = '', bty = 'n', main = path)
  rasterImage(jpg, 1, 1, res[1], res[2])
}

flagged_images <- HC %>% 
  filter(area > 2.5e05)

basedir <- "../../../h2_fec_images/h2_thresh_images/"

if (nrow(flagged_images) >= 1) {
  for (ii in 1:nrow(flagged_images)) {
    print(plot_jpeg(paste0(basedir, flagged_images$camera_id[ii])))
  }
}
```

## Prediction for all images

Linear models predicting egg count from area

Asymptotic regression through the origin (following Pinheiro and Bates, 2000):

$$handcount(area) = \theta_1\left[1 - \exp(-\exp(\theta_2) \cdot area)\right]$$

```{r fm_linear, results="hide", cache=TRUE, warning=FALSE}
linear <- read_csv("../../Data/Processed/area_summation_fine.csv")
actual_linear <- suppressWarnings(
  read_excel("../../Data/Processed/hd_hand_counted.xlsx") %>% 
  dplyr::select(camera_id, handcount)
)
actual_linear <- full_join(actual_linear, linear) %>% 
  filter(lower_thresh == linear_threshold) %>% 
  as.data.frame()

fm_lm <- lm(handcount ~ area - 1, data = actual_linear)

fm_linear <- map2stan(
  alist(
    handcount ~ dnorm(mu, sigma),
    mu <- b * area,
    b ~ dnorm(0, 1) & T[0, ],
    sigma ~ dcauchy(0, 5)
  ),
  data = actual_linear,
  start = list(b = 0.01),
  iter = 2e4,
  control = list(adapt_delta = 0.99)
)
```

```{r echo=FALSE}
plot(fm_linear)
```

Asymptotic:

```{r fm_asymp, results="hide", cache=TRUE, warning=FALSE}
fm_asymp <- map2stan(
  alist(
    handcount ~ dnorm(mu, sigma),
    mu <- theta1 * (1 - exp(-exp(theta2) * area)),
    theta1 ~ dnorm(1500, 200),
    theta2 ~ dnorm(0, 100),
    sigma ~ dcauchy(0, 5)
  ),
  data = actual,
  start = list(theta1 = 1500, theta2 = 0),
  iter = 2e4,
  control = list(adapt_delta = 0.99)
)
```

```{r echo=FALSE}
plot(fm_asymp)
```

```{r}
new_data <- data.frame(area = seq(0, 1.5 * max(actual$area), length.out = 200))
new_data$lm_pred <- predict(fm_lm, newdata = new_data)
new_data$linear_pred <- apply(link(fit = fm_linear, data = new_data), MARGIN = 2, FUN = median)

asymp_link <- link(fit = fm_asymp, data = new_data)
new_data$asymp_pred <- apply(asymp_link, MARGIN = 2, FUN = median)
asymp_bounds <- apply(asymp_link, MARGIN = 2, FUN = HPDI) %>% as.data.frame()

# new_data$asymp_pred <- coef(fm_asymp)[1] * 
#   (1 - exp(-exp(coef(fm_asymp)[2]) * new_data$area))

new_data_long <- new_data %>% 
  gather(-area, key = "Prediction_Method", value = "Count")
ggplot() +
  geom_line(data = new_data_long, aes(x = area, y = Count, color = Prediction_Method)) +
  geom_point(data = actual, aes(x = area, y = handcount))
```

```{r}
rethinking::compare(fm_linear, fm_asymp)
```

## Comparison of linear vs. asymptotic

```{r}
actual$lm_pred <- predict(fm_lm)
actual$linear_pred <- apply(link(fm_linear), 2, median)
actual$asymp_pred <- coef(fm_asymp)[1] * 
  (1 - exp(-exp(coef(fm_asymp)[2]) * actual$area))

actual %>%
  dplyr::select(handcount, lm_pred, asymp_pred, linear_pred) %>% 
  gather(-handcount, key = "Prediction_Method", value = "Count") %>% 
  ggplot(aes(x = handcount, y = Count, color = Prediction_Method)) +
  geom_point()

cor(actual$handcount, actual$lm_pred)
cor(actual$handcount, actual$asymp_pred)
```

## Predict for new data

```{r}
M$predicted_count <- coef(fm_asymp)[1] * 
  (1 - exp(-exp(coef(fm_asymp)[2]) * M$area))
```

## Checks

Check these. They are handcounted but in the set of analyzed images.

```{r}
M %>% 
  filter(is.na(test_case)) %>% 
  filter(!is.na(handcount)) %>% 
  filter(handcount != "unassessable") %>% 
  filter(handcount != "unassigned") %>% 
  mutate(handcount = as.numeric(handcount)) %>% 
  select(camera_id, handcount, predicted_count) %>% 
  filter(!is.na(predicted_count))
```

## Some exploration

```{r}
ggplot(M, aes(predicted_count)) +
  geom_histogram(bins = 30)
```

Check high and low predicted eggs

```{r}
M %>% 
  select(camera_id, predicted_count) %>% 
  arrange(desc(predicted_count))
```

```{r}
M %>% 
  select(camera_id, predicted_count) %>% 
  arrange(predicted_count)

M.low <- M %>% 
 select(camera_id, predicted_count) %>% 
 arrange(predicted_count)

M.low <- M.low[1:300,]

ee <- read_excel("../../Data/Processed/egg_notes_EGK.xlsx")
ee$Image <- paste("IMG_",ee$Image,".JPG",sep="")
ww <- which(M.low$camera_id %in% ee$Image)

M.low <- M.low[-ww,]

set.seed <- 8462
set.zeros <- M.low[sample(seq(1, nrow(M.low)), 10) , ]
```
