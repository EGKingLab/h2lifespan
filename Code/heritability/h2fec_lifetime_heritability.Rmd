---
title: "Dmel half-sib heritability in fecundity"
author: "Kevin Middleton"
date: "3/7/2017"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

#1. "Lifespan fecundity" (sum eggs per vial across days)
#2. Fecundity at weeks 1, 5, 10, e.g.
#3. Model with (week | vial) -- what does that mean?

```{r}
library(knitr)
# purl("h2fec_lifetime_heritability.Rmd", output = "h2fec_lifetime_heritability.R", documentation = 2)
```

```{r}
library(MCMCglmm)
library(tidyverse)
library(cowplot)
```

#### Heritability ###

```{r}
rerun_MCMC <- TRUE

set.seed(33416)

iter <- 2e7
burnin <- 5e4
thin <- 200
```

```{r}
h2fec <- read.table("../../Data/Processed/eggs_per_vial.txt",
                    sep = '\t',
                    dec = ".", header = TRUE,
                    stringsAsFactors = FALSE)

source("color_map.R")

# Standardize egg_total
h2fec$egg_total <- as.numeric(scale(h2fec$egg_total))

h2fec$animal <- seq(1, nrow(h2fec))
h2fec$treat <- as.factor(h2fec$treat)
```

##### high sugar, HS

```{r}
HS <- subset(h2fec, treat == "HS")

pedigree <- HS[, c("animal", "sireid", "damid")]
names(pedigree) <- c("animal", "sire", "dam")
pedigree$animal <- as.character(pedigree$animal)
sires <- data.frame(animal = unique(pedigree$sire),
                    sire = NA, dam = NA, stringsAsFactors = FALSE)
dams <- data.frame(animal = unique(pedigree$dam),
                   sire = NA, dam = NA, stringsAsFactors = FALSE)
pedigree <- bind_rows(sires, dams, pedigree) %>% as.data.frame()
```

```{r}
# Inverse Gamma(0.001; 0.001)
# a = nu / 2
# b = nu * V / 2

if (rerun_MCMC) {
  t1 <- Sys.time()
  
  prior <- list(R = list(V = 1, nu = 0.002),
                G = list(G1 = list(V = 1, nu = 0.002)))
  
  #model <- mclapply(1:chains, function(i) {
  model <- MCMCglmm(egg_total ~ 1,
                    random = ~ animal,
                    family = "gaussian",
                    prior = prior,
                    pedigree = pedigree,
                    data = HS,
                    nitt = iter,
                    burnin = burnin,
                    thin = thin,
                    verbose = TRUE)
  #}, mc.cores = chains)
  
  save(model, file = "../../Data/Processed/HS_lifetime_FEC.Rda")
  
  t2 <- Sys.time()
  cat(t2-t1)
}

```

```{r HS_analysis}
load("../../Data/Processed/HS_lifetime_FEC.Rda")

# Fixed
plot(model$Sol)
autocorr.diag(model$Sol)
effectiveSize(model$Sol)

# Random
plot(model$VCV)
autocorr.diag(model$VCV)
effectiveSize(model$VCV)

summary(model)

herit.hs <- model$VCV[, "animal"] / (model$VCV[, "animal"] + model$VCV[, "units"])
plot(herit.hs)
median(herit.hs)
h <- HPDinterval(herit.hs)
h1 <- as.data.frame(h)
```

##### Low yeast, LY

```{r}
if (rerun_MCMC) {
  t1<-Sys.time()
  
  LY <- subset(h2fec, treat == "LY")
  
  pedigree <- LY[, c("animal", "sireid", "damid")]
  names(pedigree) <- c("animal", "sire", "dam")
  pedigree$animal <- as.character(pedigree$animal)
  sires <- data.frame(animal = unique(pedigree$sire),
                      sire = NA, dam = NA, stringsAsFactors = FALSE)
  dams <- data.frame(animal = unique(pedigree$dam),
                     sire = NA, dam = NA, stringsAsFactors = FALSE)
  pedigree <- bind_rows(sires, dams, pedigree) %>% as.data.frame()
  
  # Inverse Gamma(0.001; 0.001)
  # a = nu / 2
  # b = nu * V / 2
  
  prior <- list(R = list(V = 1, nu = 0.002),
                G = list(G1 = list(V = 1, nu = 0.002)))
  
  model <- MCMCglmm(egg_total ~ 1,
                    random = ~ animal,
                    family = "gaussian",
                    prior = prior,
                    pedigree = pedigree,
                    data = LY,
                    nitt = iter,
                    burnin = burnin,
                    thin = thin,
                    verbose = TRUE)
  
  save(model, file = "../../Data/Processed/LY_lifetime_FEC.Rda")
  
  t2<-Sys.time()
  cat(t2-t1)
}
```

```{r LY_analysis}
load("../../Data/Processed/LY_lifetime_FEC.Rda")

# Fixed
plot(model$Sol)
autocorr.diag(model$Sol)
effectiveSize(model$Sol)

# Random
plot(model$VCV)
autocorr.diag(model$VCV)
effectiveSize(model$VCV)

summary(model)

herit.dr <- model$VCV[, "animal"] / (model$VCV[, "animal"] + model$VCV[, "units"])
plot(herit.dr)
median(herit.dr)
d <- HPDinterval(herit.dr)
d1 <- as.data.frame(d)
```

##### Standard, STD

```{r}
if (rerun_MCMC) {
  s1<-Sys.time()
  
  STD <- subset(h2fec, treat == "STD")
  
  pedigree <- STD[, c("animal", "sireid", "damid")]
  names(pedigree) <- c("animal", "sire", "dam")
  pedigree$animal <- as.character(pedigree$animal)
  sires <- data.frame(animal = unique(pedigree$sire),
                      sire = NA, dam = NA, stringsAsFactors = FALSE)
  dams <- data.frame(animal = unique(pedigree$dam),
                     sire = NA, dam = NA, stringsAsFactors = FALSE)
  pedigree <- bind_rows(sires, dams, pedigree) %>% as.data.frame()
  
  # Inverse Gamma(0.001; 0.001)
  # a = nu / 2
  # b = nu * V / 2
  
  prior <- list(R = list(V = 1, nu = 0.002),
                G = list(G1 = list(V = 1, nu = 0.002)))
  
  model <- MCMCglmm(egg_total ~ 1,
                    random = ~ animal,
                    family = "gaussian",
                    prior = prior,
                    pedigree = pedigree,
                    data = STD,
                    nitt = iter,
                    burnin = burnin,
                    thin = thin,
                    verbose = TRUE)
  
  save(model, file = "../../Data/Processed/STD_lifetime_FEC.Rda")
  
  s2<-Sys.time()
  cat(s2-s1)
}
```

```{r STD_analysis}
load("../../Data/Processed/STD_lifetime_FEC.Rda")

# Fixed
plot(model$Sol)
autocorr.diag(model$Sol)
effectiveSize(model$Sol)

# Random
plot(model$VCV)
autocorr.diag(model$VCV)
effectiveSize(model$VCV)

summary(model)

herit.c <- model$VCV[, "animal"] / (model$VCV[, "animal"] + model$VCV[, "units"])
plot(herit.c)
median(herit.c)
c <- HPDinterval(herit.c)
c1 <- as.data.frame(c)
```

# The three files together

```{r}
hs.samp$Diet <- "HS"
dr.samp$Diet <- "DR"
c.samp$Diet <- "C"

hs.samp$HS <- NULL
dr.samp$DR <- NULL
c.samp$C <- NULL
heritab <- rbind(hs.samp, dr.samp, c.samp)
save(heritab, file = "../../Data/Processed/herit_lifetime.Rda")
```

# Plot treatments together

```{r}
load("../../Data/Processed/herit_lifetime.Rda")
ll <- 18
ss <-0.6

 ggplot(heritab, aes(var1, fill = Diet)) + 
  geom_density(alpha = 0.2) +
  geom_segment(x = 0.0006355559,
               y = ll + ss,
               xend = 0.5736901,
               yend = ll+ss,
               position = "identity",
               colour = "mediumpurple1")+
  geom_segment(x = 0.00025302,
               y = ll+ss+ss,
               xend = 0.331502,
               yend = ll+ss+ss,
               position = "identity",
               colour = "darkseagreen2")+
  geom_segment(x = 0.0003154024,
               y = ll,
               xend = 0.9160698,
               yend = ll,
               position = "identity",
               colour = "lightpink")+
  #coord_cartesian(xlim=c(0, 1), ylim=c(0, 1)) + #adjust frame of x-axis
  #scale_x_continuous(expand=c(0, 0), limits=c(-3, 100)) + #limit plot area on x-axix
  expand_limits(y = c(0, 20)) +
  expand_limits(x = c(-0.2, 1.2)) +
  theme(axis.title = element_text(size = 12)) +
  xlab("Heritability") +
  ylab("Density") +
  theme(legend.position=c(0.85, 0.85)) +
  scale_fill_discrete(name ="Diet", labels=c("C", "DR", "HS")) 
 
 ggsave(last_plot(), file = "../../Figures/Fecundity_heritability_lifetime_plots.pdf",
       width = 4, height = 4)
```

```{r}
#Diet_treat <- c("h2.c","h2.dr","h2.hs")
#Heritability <- c(herit.c, herit.dr, herit.hs)
#cdh <- data.frame(Diet_treat,Heritability)
  
median_FEC <- c("median.C","median.DR","median.HS")
median_HERIT <- c(median(herit.c), median(herit.dr), median(herit.hs))
median_cdh <- data.frame(median_FEC, median_HERIT)

ggplot(median_cdh, aes(x=median_FEC, y=median_HERIT, color=Diet_treat)) +
  geom_jitter() 
  #geom_point(median_cdh, aes(x=Diet_treat, y=median_HERIT))
```
