---
title: "halfsib_survival - heritability"
author: "Enoch Ng'oma"
date: "3/7/2017"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
---

#Analysis of lifespan 
#Half-sibling fly data

#### Heritability ###

```{r eval=TRUE}
set.seed(37264)

library(MCMCglmm)
library(tidyverse)

iter <- 1000000
burnin <- 15000

h2life <- read.table('../Data/Processed/Female_events_lifespan.txt',
                     sep = "\t", header = TRUE,
                     stringsAsFactors = FALSE)

h2_filtered <- h2life[h2life$status!=3, ] # remove censored events
h2_filtered$animal <- seq(1, nrow(h2_filtered))
h2_filtered$treat <- as.factor(h2_filtered$treat)
```

##### high sugar, HS

```{r}
HS <- subset(h2_filtered, treat == "HS")

pedigree <- HS[, c("animal", "sireid", "damid")]
names(pedigree) <- c("animal", "sire", "dam")
pedigree$animal <- as.character(pedigree$animal)
sires <- data.frame(animal = unique(pedigree$sire),
                    sire = NA, dam = NA, stringsAsFactors = FALSE)
dams <- data.frame(animal = unique(pedigree$dam),
                   sire = NA, dam = NA, stringsAsFactors = FALSE)
pedigree <- bind_rows(sires, dams, pedigree) %>% as.data.frame()

# Inverse Gamma(0.001; 0.001)
# a = nu / 2
# b = nu * V / 2

prior <- list(R = list(V = 1, nu = 0.002),
              G = list(G1 = list(V = 1, nu = 0.002)))

model <- MCMCglmm(NewAge ~ 1,
                  random = ~ animal,
                  family = "gaussian",
                  prior = prior,
                  pedigree = pedigree,
                  data = HS,
                  nitt = iter,
                  burnin = burnin,
                  thin = 50,
                  verbose = FALSE)

save(model, file = "../Data/Processed/HS.Rda")
```

```{r}
load("../Data/Processed/HS.Rda")
# Fixed
plot(model$Sol)
autocorr.diag(model$Sol)
effectiveSize(model$Sol)

# Random
plot(model$VCV)
autocorr.diag(model$VCV)
effectiveSize(model$VCV)

summary(model)

herit <- model$VCV[, "animal"] / (model$VCV[, "animal"] + model$VCV[, "units"])
plot(herit)
median(herit)
HPDinterval(herit)
```

```{r brms_model}

```


```{r}
iter <- 650000
burnin <- 15000

##### low yeast, LY

LY <- subset(h2_filtered, treat == "LY")

pedigree <- LY[, c("animal", "sireid", "damid")]
names(pedigree) <- c("animal", "sire", "dam")
pedigree$animal <- as.character(pedigree$animal)
sires <- data.frame(animal = unique(pedigree$sire),
                    sire = NA, dam = NA, stringsAsFactors = FALSE)
dams <- data.frame(animal = unique(pedigree$dam),
                   sire = NA, dam = NA, stringsAsFactors = FALSE)
pedigree <- bind_rows(sires, dams, pedigree) %>% as.data.frame()

# Inverse Gamma(0.001; 0.001)
# a = nu / 2
# b = nu * V / 2

prior <- list(R = list(V = 1, nu = 0.002),
              G = list(G1 = list(V = 1, nu = 0.002)))

model <- MCMCglmm(NewAge ~ 1,
                  random = ~ animal,
                  family = "gaussian",
                  prior = prior,
                  pedigree = pedigree,
                  data = LY,
                  nitt = iter,
                  burnin = burnin,
                  thin = 50,
                  verbose = FALSE)

save(model, file = "../Data/Processed/LY.Rda")
```

```{r}
load("../Data/Processed/LY.Rda")
# Fixed
plot(model$Sol)
autocorr.diag(model$Sol)
effectiveSize(model$Sol)

# Random
plot(model$VCV)
autocorr.diag(model$VCV)
effectiveSize(model$VCV)

summary(model)

herit <- model$VCV[, "animal"] / (model$VCV[, "animal"] + model$VCV[, "units"])
plot(herit)
median(herit)
HPDinterval(herit)
```

```{r}
iter <- 650000
burnin <- 15000

##### control, STD

STD <- subset(h2_filtered, treat == "STD")

pedigree <- STD[, c("animal", "sireid", "damid")]
names(pedigree) <- c("animal", "sire", "dam")
pedigree$animal <- as.character(pedigree$animal)
sires <- data.frame(animal = unique(pedigree$sire),
                    sire = NA, dam = NA, stringsAsFactors = FALSE)
dams <- data.frame(animal = unique(pedigree$dam),
                   sire = NA, dam = NA, stringsAsFactors = FALSE)
pedigree <- bind_rows(sires, dams, pedigree) %>% as.data.frame()

# Inverse Gamma(0.001; 0.001)
# a = nu / 2
# b = nu * V / 2

prior <- list(R = list(V = 1, nu = 0.002),
              G = list(G1 = list(V = 1, nu = 0.002)))

model <- MCMCglmm(NewAge ~ 1,
                  random = ~ animal,
                  family = "gaussian",
                  prior = prior,
                  pedigree = pedigree,
                  data = STD,
                  nitt = iter,
                  burnin = burnin,
                  thin = 50,
                  verbose = FALSE)

save(model, file = "../Data/Processed/STD.Rda")
```

```{r}
load("../Data/Processed/STD.Rda")
# Fixed
plot(model$Sol)
autocorr.diag(model$Sol)
effectiveSize(model$Sol)

# Random
plot(model$VCV)
autocorr.diag(model$VCV)
effectiveSize(model$VCV)

summary(model)

herit <- model$VCV[, "animal"] / (model$VCV[, "animal"] + model$VCV[, "units"])
plot(herit)
median(herit)
HPDinterval(herit)
```
