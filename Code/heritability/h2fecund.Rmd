---
title: "h2fecund"
author: "Enoch Ng'oma"
date: "3/6/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

setwd("~/MyGithub/h2fecundspan/Code/heritability")
```

#Read in data

```{r}
load(file= "../../Data/Processed/predicted_egg_counts.rda")
h2life <- read.table('../../Data/Processed/lifespan_correctedData.txt',
                     sep = "\t", header = TRUE,
                     stringsAsFactors = FALSE)
```

#Merge predicted counts and hand counts

```{r}
# hand count preferred where it occurs
M$egg_count <- if_else(!is.na(M$handcount), 
                       M$handcount, M$predicted_count_linear)

# check
#M[1:20, c(1,3,25:27)]
#M[201:220, c(1,3,25:27)]

```

#Merge with lifespan to get number of females


```{r}

#strip away columns not needed

# create "id" column from fID and treat
M <- unite(M, "id", fID, treat, sep = "_", remove=FALSE)

ureps <- unique(h2life$id)

h2life$upN <- rep(NA, nrow(h2life))

h2life.t <- h2life[0,]


for(k in ureps)
{
  h2life.s <- subset(h2life, id==k)
  for(i in 1:nrow(h2life.s))
  {
   if(i == 1)
   {
     h2life.s[i,'upN'] <- h2life.s$NstartF[1]
   }else{
     if(is.na(h2life.s$deadF[i])|is.na(h2life.s$carriedF[(i-1)]))
     {
       h2life.s[i,'upN'] <- h2life.s[(i-1),'upN']
     }else{
     ndead <- h2life.s[i,'deadF']-h2life.s[(i-1),'carriedF']
     
     h2life.s[i,'upN'] <- h2life.s[(i-1),'upN']-ndead
     }#else close
   }#else close
  }#for i close
  h2life.t <- rbind(h2life.t, h2life.s)
}#for k close

h2life <- h2life.t

min(h2life$upN,na.rm=TRUE)
which(is.na(h2life$upN))
h2life[which(h2life$upN<0),]
hist(h2life[which(h2life$upN<0),'upN'])


# set negative upN values to zero
h2life[h2life$upN<0,'upN']<-0
h2life[which(h2life$upN<0),]




# pull all Mondays from 2/29 to 6/20
# females present on each Monday are gave the eggs collected each Tuesday
Mondays <- as.Date("2016-02-29") #YYYY-MM-DD
weekdays(Mondays)
xm <- seq(Mondays, by="7 days", length.out=17)


# pull rows holding Monday and Tuesday flips
dd <- subset(h2life, flipDate %in% as.character(xm))


M$NewAge <- as.numeric(M$flipDate - M$setDate)+2 # for checking join

M$setDate <- as.character(M$setDate)
M$flipDate <- as.character(M$flipDate)

test <- right_join(M, dd)



#ddm$variable <- rownames(ddm)
#MMi_ddm_join <- merge(MMi, ddm, by="flipD_id")

for(i in 1:nrow(MMi)){
  for( j in 1:nrow(ddm)){
    if (MMi[i,1]==ddm[j,1]) MMi[i,3]<- ddm[j,2]
  }
}
```






```{r}
```


```{r}
```


```{r}
```